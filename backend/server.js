
// const arrayOfProducts = [{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },{
//   "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
//   "model": "Samsung Galaxy S23",
//   "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
//   "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
//   "price": 999,
//   "discountPrice": 159,
//   "category": "Mobile",
//   "inStock": true,
//   "rating": 3.8,
//   "reviews": 345
//   },]


// server/index.js

const arrayOfProducts=[
  {
    "name": "Abstract Multicolor Seamless Snap Case for iPhone 16 Pro (5G)",
    "model": "Samsung Galaxy S23",
    "image": "https://zapvi.in/wp-content/uploads/2024/10/B-SAMSUNGGALAXYS23ULTRA-1076.jpg",
    "description": "A bold design featuring violence symbols for a tough and edgy look, suitable for a more rebellious vibe.",
    "price": 999,
    "discountPrice": 159,
    "category": "Mobile",
    "inStock": true,
    "rating": 3.8,
    "reviews": 345
  },
 {
    "name": "Floral Pattern Glass Case for iPhone 15 Pro Max",
    "model": "Apple iPhone 15",
    "image": "https://media.idownloadblog.com/wp-content/uploads/2019/09/miracase-iphone-11.jpg",
    "description": "Elegant floral design on tempered glass for a premium feel and strong protection.",
    "price": 1299,
    "discountPrice": 199,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.5,
    "reviews": 512
  },
  {
    "name": "Carbon Fiber Shockproof Case for Samsung S24 Ultra",
    "model": "Samsung Galaxy S24 Ultra",
    "image": "https://media.takealot.com/covers_images/1fc3e90c877b49ad846dfca8e2bbc5e1/s-zoom.file",
    "description": "Premium carbon fiber texture with shock-absorbing corners for ultimate protection.",
    "price": 1499,
    "discountPrice": 249,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.7,
    "reviews": 287
  },
  {
    "name": "Retro Art Silicone Case for OnePlus 12R",
    "model": "OnePlus 12R",
    "image": "https://www.dubaidutyfree.com/ccstore/v1/images/?source=/file/v6816457353769651259/products/112923225.0.jpg&height=940&width=940",
    "description": "Soft silicone case with retro artwork for a unique and artistic look.",
    "price": 899,
    "discountPrice": 129,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.2,
    "reviews": 189
  },
  {
    "name": "Marble Glossy Finish Case for Google Pixel 8",
    "model": "Google Pixel 8",
    "image": "https://ak-asset.jarir.com/akeneo-prod/asset/7/3/e/b/73eb98461058776faa0cdcb81660f162fc60a020_595303.jpg",
    "description": "Glossy marble pattern case with anti-fingerprint coating for a sleek look.",
    "price": 1099,
    "discountPrice": 179,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.6,
    "reviews": 412
  },
  {
    "name": "Matte Black Rugged Case for iPhone 14",
    "model": "Apple iPhone 14",
    "image": "https://istyle.rs/media/catalog/product/m/h/mhll3_av2.jpg",
    "description": "Matte black case with military-grade drop protection.",
    "price": 1199,
    "discountPrice": 199,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.8,
    "reviews": 563
  },
  {
    "name": "Futuristic Cyberpunk Case for Samsung Galaxy S22",
    "model": "Samsung Galaxy S22",
    "image": "https://i.pinimg.com/736x/17/9a/d4/179ad42b6909364d1cd2cc5c9e76b1b9.jpg",
    "description": "Futuristic cyberpunk-style case with glowing neon patterns.",
    "price": 1399,
    "discountPrice": 219,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.5,
    "reviews": 341
  },
  {
    "name": "Transparent Slim Fit Case for OnePlus Nord 3",
    "model": "OnePlus Nord 3",
    "image": "https://static.esrgear.com/wp-content/uploads/2022/09/iPhone-14-Pro-Classic-Hybrid-Case-with-HaloLock-2-1.jpg",
    "description": "Ultra-thin and clear case to show off your device’s design.",
    "price": 799,
    "discountPrice": 99,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.1,
    "reviews": 271
  },
  {
    "name": "Leather Wallet Case for iPhone 13 Pro",
    "model": "Apple iPhone 13 Pro",
    "image": "https://cdn.shopify.com/s/files/1/0435/3277/9677/products/Hf5696c4cbea242b6a2b7190c8a1595d3e_1024x1024.jpg?v=1627330134",
    "description": "Genuine leather case with card slots and a magnetic closure.",
    "price": 1599,
    "discountPrice": 299,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.9,
    "reviews": 628
  },
  {
    "name": "Graffiti Art Case for Samsung Galaxy A54",
    "model": "Samsung Galaxy A54",
    "image": "https://ak-asset.jarir.com/akeneo-prod/asset/2/7/3/2/27323191d416cd36584767ee38a615827c3488f7_590882.jpg",
    "description": "Street-style graffiti art case for a unique and funky vibe.",
    "price": 1099,
    "discountPrice": 159,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.3,
    "reviews": 315
  },
  {
    "name": "Comic Style Case for Google Pixel 7",
    "model": "Google Pixel 7",
    "image": "https://images.mobilefun.co.uk/graphics/productgalleries/90999/b.jpg",
    "description": "Vibrant comic book artwork printed on a high-durability case.",
    "price": 1199,
    "discountPrice": 189,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.5,
    "reviews": 398
  },
  {
    "name": "Crystal Glitter Case for iPhone SE (2022)",
    "model": "Apple iPhone SE (2022)",
    "image": "https://5.imimg.com/data5/SELLER/Default/2022/4/XX/DL/CX/102234567/apple-iphone-12-pro-mobile-back-cover-1000x1000.JPG",
    "description": "Shiny glitter case with a soft-touch grip for extra elegance.",
    "price": 999,
    "discountPrice": 149,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.7,
    "reviews": 267
  },
  {
    "name": "Minimalist Shockproof Case for OnePlus 11R",
    "model": "OnePlus 11R",
    "image": "https://www.pngmart.com/files/4/Phone-Case-Transparent-PNG.png",
    "description": "Slim yet highly protective case for a sleek and modern look.",
    "price": 899,
    "discountPrice": 129,
    "category": "Mobile",
    "inStock": true,
    "rating": 4.2,
    "reviews": 176
  }
]


const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const { Password } = require("@mui/icons-material");
const nodemailer = require("nodemailer");
require("dotenv").config();

const app = express();

// Middleware
app.use(
  cors({
    origin: "http://localhost:3000", // Allow your frontend
    methods: "GET,POST,PUT,PATCH,DELETE",
    allowedHeaders: "Content-Type,Authorization",
    credentials: true, // Allow cookies and authentication headers
  })
);

app.use(express.json());

// app.use(
//   cors({
//     origin: "http://localhost:3000", // Your frontend URL
//     credentials: true,
//   })
// );

// MongoDB Connection



mongoose
  .connect(process.env.MONGODB_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("Connected to MongoDB"))
  .catch((err) => console.error("MongoDB connection error:", err));

const PORT = process.env.PORT || 5000;

// Product Schema
const productSchema = new mongoose.Schema({
  name: String,
  model: String,
  image: String,
  description: String,
  price: Number,
  discountPrice: Number,
  category: String,
  inStock: { type: Boolean, default: true },
  rating: { type: Number, default: 4.5 },
  reviews: { type: Number, default: 0 },
});
const Product = mongoose.model("Product", productSchema);

// Cart Schema
const cartSchema = new mongoose.Schema({
  userId: String,
  items: [
    {
      productId: { type: mongoose.Schema.Types.ObjectId, ref: "Product" },
      quantity: Number,
    },
  ],
});

const Cart = mongoose.model("Cart", cartSchema);

// User Schema
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    trim: true,
    minlength: 2,
  },
  email: {
    type: String,
    required: true,
    unique: true,
    trim: true,
    lowercase: true,
  },
  password: {
    type: String,
    required: true,
    minlength: 8,
  },
  role: {
    type: String,
    enum: ["user", "admin"],
    default: "user",
  },
  createdAt: {
    type: Date,
    default: Date.now,
  },
});

const User = mongoose.model("User", userSchema);

// Authentication Middleware
const authMiddleware = async (req, res, next) => {
  try {
    const token = req.header("Authorization")?.replace("Bearer ", "");
    if (!token) {
      throw new Error("No token provided");
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId);

    if (!user) {
      throw new Error("User not found");
    }

    req.user = user;
    req.token = token;
    next();
  } catch (error) {
    res.status(401).json({ error: "Please authenticate" });
  }
};

// Routes
// Signup Route
app.post("/api/auth/signup", async (req, res) => {
  try {
    const { name, email, password } = req.body;

    // Check if user already exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ error: "Email already registered" });
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 12);

    // Create new user
    const user = new User({
      name,
      email,
      password: hashedPassword,
      role: email === "admin@example.com" ? "admin" : "user",
    });

    await user.save();




    // Generate JWT token
    const token = jwt.sign(
      { userId: user._id, email: user.email },
      process.env.JWT_SECRET,
      { expiresIn: "1h" }
    );

    res.status(201).json({
      message: "User created successfully",
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
      },
      token,
    });
  } catch (error) {
    res.status(500).json({ error: "Error creating user" });
  }
});

// Login Route
app.post("/api/auth/login", async (req, res) => {
  try {
    const { email, password } = req.body;
    console.log(email,password,"enailllll")

    // Find user
    const user = await User.findOne({ email });
    console.log(user)
    if (!user) {
      return res.status(401).json({ error: "Invalid credentials" });
    }

    // Check password
    const isPasswordValid = await bcrypt.compare(password, user.password);
    if (!isPasswordValid) {
      return res.status(401).json({ error: "Invalid credentials" });
    }

    // Generate JWT token
    const token = jwt.sign(
      { userId: user._id, email: user.email },
      process.env.JWT_SECRET,
      { expiresIn: "1h" }
    );
    console.log("JWT_SECRET:", process.env.JWT_SECRET);

    console.log(token,"token")

    res.json({
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
      },
      token,
    });
    
  } catch (error) {
    res.status(500).json({ error: "Error logging in" });
  }
});

// Protected Route Example
app.get("/api/auth/me", authMiddleware, async (req, res) => {
  try {
    res.json({
      user: {
        id: req.user._id,
        name: req.user.name,
        email: req.user.email,
        role: req.user.role,
      },
    });
  } catch (error) {
    res.status(500).json({ error: "Error fetching user data" });
  }
});

// Logout Route
app.post("/api/auth/logout", authMiddleware, async (req, res) => {
  try {
    // In a real application, you might want to blacklist the token
    // For now, we'll just send a success response
    res.json({ message: "Logged out successfully" });
  } catch (error) {
    res.status(500).json({ error: "Error logging out" });
  }
});

// Get product details by ID
app.get("/api/products/detail/:id", async (req, res) => {
  try {
    const product = await Product.findById(req.params.id);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }
    res.json(product);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

// Get products by category
app.get("/api/products/:category", async (req, res) => {
  try {
    const { category } = req.params;
    let query = {};

    if (category !== "all") {
      query.category = category;
    }

    const products = await Product.find(query);
    res.json(products);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

// Add to cart
app.post("/api/cart/add", async (req, res) => {
  try {
    const { userId, productId, quantity } = req.body;

    let cart = await Cart.findOne({ userId });

    if (!cart) {
      cart = new Cart({ userId, items: [] });
    }

    const existingItem = cart.items.find(
      (item) => item.productId.toString() === productId
    );

    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      cart.items.push({ productId, quantity });
    }

    await cart.save();
    res.json(cart);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

// Get cart
app.get('/api/cart/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const cart = await Cart.findOne({ userId }).populate('items.productId');
    res.json(cart || { userId, items: [] });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

app.get("/api/users/getUserId/:email", async (req, res) => {
  try {
    const user = await User.findOne({ email: req.params.email });
    if (!user) return res.status(404).json({ error: "User not found" });

    res.json({ userId: user._id });
  } catch (error) {
    res.status(500).json({ error: "Server error" });
  }
});

// Get cart route
app.get("/api/cart/:userId", async (req, res) => {
  try {
    const { userId } = req.params;
    const cart = await Cart.findOne({ userId }).populate("items.productId");

    if (!cart) {
      // Return empty cart if none exists
      return res.json({ userId, items: [] });
    }

    res.json(cart);
  } catch (error) {
    console.error("Error fetching cart:", error);
    res.status(500).json({ message: error.message });
  }
});

// Update cart item quantity
app.patch("/api/cart/:userId/item/:productId", async (req, res) => {
  try {
    const { userId, productId } = req.params;
    const { quantity } = req.body;

    let cart = await Cart.findOne({ userId });

    if (!cart) {
      cart = new Cart({ userId, items: [] });
    }

    const itemIndex = cart.items.findIndex(
      (item) => item.productId.toString() === productId
    );

    if (itemIndex > -1) {
      cart.items[itemIndex].quantity = quantity;
    } else {
      cart.items.push({ productId, quantity });
    }

    await cart.save();
    res.json(cart);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

// Remove cart item
app.delete("/api/cart/:userId/item/:productId", async (req, res) => {
  try {
    const { userId, productId } = req.params;

    const cart = await Cart.findOne({ userId });
    if (!cart) {
      return res.status(404).json({ message: "Cart not found" });
    }

    cart.items = cart.items.filter(
      (item) => item.productId.toString() !== productId
    );

    await cart.save();
    res.json(cart);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

app.get("/api/products", async (req, res) => {
  try {
    const products = await Product.find();
    res.json(products);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.get("/api/translations/:lang", async (req, res) => {
  try {
    const { lang } = req.params;
    const translation = await mongoose.connection.db
      .collection("translations")
      .findOne({ language: lang });

    if (!translation) {
      return res.status(404).json({ error: "Translations not found" });
    }

    res.json(translation.translations);
  } catch (error) {
    console.error("Error fetching translations:", error);
    res.status(500).json({ error: "Server error" });
  }
});

app.get("/api/products/:id", async (req, res) => {
  try {
    const product = await Product.findById(req.params.id);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }
    res.json(product);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// In your Express backend
app.post("/api/add-products", async (req, res) => {
  try {
    const products = req.body; // This should be an array or a single object
    console.log("Received products:", products);

    if (!Array.isArray(products)) {
      // If it's a single object, convert it into an array
      await Product.create(products);
    } else {
      // If it's already an array, insert multiple
      await Product.insertMany(products);
    }

    res.status(201).json({ message: "Products added successfully" });
  } catch (error) {
    console.error("Error adding products:", error);
    res.status(500).json({ error: error.message });
  }
});
// New Order Schema
const orderSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: "User", required: true },
  items: [
    {
      productId: { type: mongoose.Schema.Types.ObjectId, ref: "Product" },
      quantity: Number,
      price: Number,
    },
  ],
  totalAmount: Number,
  shippingAddress: {
    name: String,
    address: String,
    city: String,
    state: String,
    zipCode: String,
    phone: String,
  },
  paymentMethod: String,
  paymentStatus: { type: String, default: "Pending" },
  orderStatus: { type: String, default: "Processing" },
  createdAt: { type: Date, default: Date.now },
});

const Order = mongoose.model("Order", orderSchema);

// Payment and Order Creation Route
app.post("/api/orders", authMiddleware, async (req, res) => {
  try {
    const { items, totalAmount, shippingAddress, paymentMethod } = req.body;

    // Create a new order
    const newOrder = new Order({
      userId: req.user._id,
      items,
      totalAmount,
      shippingAddress,
      paymentMethod,
    });

    // Save the order
    await newOrder.save();

    // Clear the user's cart
    await Cart.findOneAndUpdate(
      { userId: req.user._id },
      { $set: { items: [] } }
    );

    // Here you would typically integrate with a payment gateway
    // For this example, we'll simulate a successful payment
    newOrder.paymentStatus = "Paid";
    newOrder.orderStatus = "Confirmed";
    await newOrder.save();

    res.status(201).json({
      message: "Order placed successfully",
      orderId: newOrder._id,
    });
  } catch (error) {
    console.error("Error creating order:", error);
    res.status(500).json({ error: "Error creating order" });
  }
});

// Get User's Orders
app.get("/api/orders", authMiddleware, async (req, res) => {
  try {
    const orders = await Order.find({ userId: req.user._id })
      .populate("items.productId")
      .sort({ createdAt: -1 });

    res.json(orders);
  } catch (error) {
    console.error("Error fetching orders:", error);
    res.status(500).json({ error: "Error fetching orders" });
  }
});

// Admin: Get All Orders
app.get("/api/admin/orders", authMiddleware, async (req, res) => {
  try {
    if (req.user.role !== "admin") {
      return res.status(403).json({ error: "Access denied" });
    }

    const orders = await Order.find()
      .populate("userId", "name email")
      .populate("items.productId")
      .sort({ createdAt: -1 });

    res.json(orders);
  } catch (error) {
    console.error("Error fetching all orders:", error);
    res.status(500).json({ error: "Error fetching all orders" });
  }
});

// Admin: Update Order Status
app.patch("/api/admin/orders/:orderId", authMiddleware, async (req, res) => {
  try {
    if (req.user.role !== "admin") {
      return res.status(403).json({ error: "Access denied" });
    }

    const { orderId } = req.params;
    const { orderStatus } = req.body;

    const updatedOrder = await Order.findByIdAndUpdate(
      orderId,
      { orderStatus },
      { new: true }
    );

    if (!updatedOrder) {
      return res.status(404).json({ error: "Order not found" });
    }

    res.json(updatedOrder);
  } catch (error) {
    console.error("Error updating order status:", error);
    res.status(500).json({ error: "Error updating order status" });
  }
});


app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

console.log("Server is running and ready to handle orders and payments.");



// -----------------------------------------forgot Password----------------------------------------

// var mailTransporter = nodemailer.createTransport({
//   host: "smtp.gmail.com",
//   port:587,
//   secure: false,
//   auth: {
//     user: "bongusaicustq11@gmail.com",
//     pass: "ldfg yozk sbby xzto",
//   },
// });

// var options = {
//   from: "bongusaicustq11@gmail.com",
//   to: "bunnycustq@gmail.com",
//   subject: "Password Reset",
//   text: "mayya Password Reset cheyyyy",
// };

// mailTransporter.sendMail(options, function (err, info) {
//   if (err) {
//     console.log(err);
//   } else {
//     console.log("send");
//   }
// })

// -----------------------------------------------------------------

let otpStorage = {};


const mailTransporter = nodemailer.createTransport({
  host: "smtp.gmail.com",
  port: 587,
  secure: false,
  auth: {
    user: "bongusaicustq11@gmail.com",
    pass: "ldfg yozk sbby xzto",
  },
});

app.post("/api/auth/send-otp", async (req, res) => {
  const { email } = req.body;
  const user = await User.findOne({ email });
  if (!user) return res.status(400).json({ error: "User not found" });

  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  otpStorage[email] = otp;

  const options = {
    from: "bongusaicustq11@gmail.com",
    to: email,
    subject: "Password Reset OTP",
    text: `Your OTP for password reset is: ${otp}`,
  };

  mailTransporter.sendMail(options, (err) => {
    if (err) return res.status(500).json({ error: "Error sending email" });
    res.json({ message: "OTP sent successfully", otp });
  });
});

app.post("/api/auth/update-password", async (req, res) => {
  const { email, newPassword } = req.body;
  const user = await User.findOne({ email });
  if (!user) return res.status(400).json({ error: "User not found" });

  const hashedPassword = await bcrypt.hash(newPassword, 12);
  user.password = hashedPassword;
  await user.save();

  res.json({ message: "Password updated successfully" });
});




